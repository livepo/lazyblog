name: Deploy on Tag

on:
  push:
    tags:
      - '*'

jobs:
  build:
    name: Build binary
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.set_tag.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'

      - name: "Build (portable: CGO disabled)"
        env:
          CGO_ENABLED: '0'
          GOOS: 'linux'
          GOARCH: 'amd64'
        run: |
          echo "Building (CGO disabled, GOOS=linux GOARCH=amd64)..."
          go version
          go env
          # Build the main web server binary from cmd/main.go to avoid other CLI mains in cmd/
          # -ldflags "-s -w" strips debug info to make the binary smaller
          go build -v -ldflags "-s -w" -o lazyblog ./cmd/main.go

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: lazyblog-binary
          path: lazyblog

      - id: set_tag
        name: Export tag name
        run: |
          # github.ref is refs/tags/<tag>
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT

  deploy-debug:
    name: Deploy to test (debug) when tag ends with -debug
    runs-on: ubuntu-latest
    needs: build
    if: endsWith(needs.build.outputs.tag, '-debug')
    steps:
      - name: Download built binary
        uses: actions/download-artifact@v4
        with:
          name: lazyblog-binary

      - name: Prepare SSH for test server
        run: |
          mkdir -p ~/.ssh
          printf '%s' "${{ secrets.TEST_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.TEST_HOST }}" >> ~/.ssh/known_hosts

      - name: Create deploy archive (test)
        run: |
          # include lazyblog and optional static/templates directories if present
          FILES="lazyblog"
          if [ -d static ]; then FILES="$FILES static"; fi
          if [ -d templates ]; then FILES="$FILES templates"; fi
          tar -czf deploy.tar.gz $FILES || true

      - name: Upload deploy archive to test host
        run: |
          PORT="${{ secrets.TEST_SSH_PORT }}"
          if [ -n "$PORT" ]; then SCP_PORT_FLAG="-P $PORT"; else SCP_PORT_FLAG=""; fi
          scp $SCP_PORT_FLAG deploy.tar.gz "${{ secrets.TEST_USER }}@${{ secrets.TEST_HOST }}:~/deploy.tar.gz"
          rm -f deploy.tar.gz
      - name: Upload remote_deploy.sh and run deploy (test)
        run: |
          # copy helper script to remote and run it with args
          PORT="${{ secrets.TEST_SSH_PORT }}"
          if [ -n "$PORT" ]; then SCP_PORT_FLAG="-P $PORT"; SSH_PORT_FLAG="-p $PORT"; else SCP_PORT_FLAG=""; SSH_PORT_FLAG=""; fi
          scp $SCP_PORT_FLAG scripts/remote_deploy.sh "${{ secrets.TEST_USER }}@${{ secrets.TEST_HOST }}:~/remote_deploy.sh"
          ssh $SSH_PORT_FLAG "${{ secrets.TEST_USER }}@${{ secrets.TEST_HOST }}" "chmod +x ~/remote_deploy.sh && bash ~/remote_deploy.sh --service '${{ secrets.TEST_SERVICE_NAME }}' --target '${{ secrets.TEST_PATH }}' --archive ~/deploy.tar.gz --backups-dir /var/backups --keep 3 --health-url 'http://127.0.0.1:8080/ready' --health-timeout 2"

  deploy-prod:
    name: Deploy to production when tag does NOT end with -debug
    runs-on: ubuntu-latest
    needs: build
    if: endsWith(needs.build.outputs.tag, '-debug') == false
    steps:
      - name: Download built binary
        uses: actions/download-artifact@v4
        with:
          name: lazyblog-binary

      - name: Prepare SSH for prod server
        run: |
          mkdir -p ~/.ssh
          printf '%s' "${{ secrets.PROD_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.PROD_HOST }}" >> ~/.ssh/known_hosts

      - name: Create deploy archive (prod)
        run: |
          FILES="lazyblog"
          if [ -d static ]; then FILES="$FILES static"; fi
          if [ -d templates ]; then FILES="$FILES templates"; fi
          tar -czf deploy.tar.gz $FILES || true

      - name: Upload deploy archive to prod host
        run: |
          PORT="${{ secrets.PROD_SSH_PORT }}"
          if [ -n "$PORT" ]; then SCP_PORT_FLAG="-P $PORT"; else SCP_PORT_FLAG=""; fi
          scp $SCP_PORT_FLAG deploy.tar.gz "${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }}:~/deploy.tar.gz"
          rm -f deploy.tar.gz

      - name: Upload remote_deploy.sh and run deploy (prod)
        run: |
          # copy helper script to remote and run it with args (prod)
          PORT="${{ secrets.PROD_SSH_PORT }}"
          if [ -n "$PORT" ]; then SCP_PORT_FLAG="-P $PORT"; SSH_PORT_FLAG="-p $PORT"; else SCP_PORT_FLAG=""; SSH_PORT_FLAG=""; fi
          scp $SCP_PORT_FLAG scripts/remote_deploy.sh "${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }}:~/remote_deploy.sh"
          ssh $SSH_PORT_FLAG "${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }}" "chmod +x ~/remote_deploy.sh && bash ~/remote_deploy.sh --service '${{ secrets.PROD_SERVICE_NAME }}' --target '${{ secrets.PROD_PATH }}' --archive ~/deploy.tar.gz --backups-dir /var/backups --keep 3 --health-url 'http://127.0.0.1:8080/ready' --health-timeout 2"
