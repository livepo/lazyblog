name: Deploy on Tag

on:
  push:
    tags:
      - '*'

jobs:
  build:
    name: Build binary
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.set_tag.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'

      - name: "Build (portable: CGO disabled)"
        env:
          CGO_ENABLED: '0'
          GOOS: 'linux'
          GOARCH: 'amd64'
        run: |
          echo "Building (CGO disabled, GOOS=linux GOARCH=amd64)..."
          go version
          go env
          # Build the main web server binary from cmd/main.go to avoid other CLI mains in cmd/
          # -ldflags "-s -w" strips debug info to make the binary smaller
          go build -v -ldflags "-s -w" -o lazyblog ./cmd/main.go

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: lazyblog-binary
          path: lazyblog

      - id: set_tag
        name: Export tag name
        run: |
          # github.ref is refs/tags/<tag>
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT

  deploy-debug:
    name: Deploy to test (debug) when tag ends with -debug
    runs-on: ubuntu-latest
    needs: build
    if: endsWith(needs.build.outputs.tag, '-debug')
    steps:
      - name: Download built binary
        uses: actions/download-artifact@v4
        with:
          name: lazyblog-binary

      - name: Prepare SSH for test server
        run: |
          mkdir -p ~/.ssh
          printf '%s' "${{ secrets.TEST_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.TEST_HOST }}" >> ~/.ssh/known_hosts

      - name: Create deploy archive (test)
        run: |
          # include lazyblog and optional static/templates directories if present
          FILES="lazyblog"
          if [ -d static ]; then FILES="$FILES static"; fi
          if [ -d templates ]; then FILES="$FILES templates"; fi
          tar -czf deploy.tar.gz $FILES || true

      - name: Upload deploy archive to test host
        run: |
          PORT="${{ secrets.TEST_SSH_PORT }}"
          if [ -n "$PORT" ]; then SCP_PORT_FLAG="-P $PORT"; else SCP_PORT_FLAG=""; fi
          scp $SCP_PORT_FLAG deploy.tar.gz "${{ secrets.TEST_USER }}@${{ secrets.TEST_HOST }}:~/deploy.tar.gz"
          rm -f deploy.tar.gz

      - name: Stop service, extract archive, move files and start (test) with backup & healthcheck
        run: |
          PORT="${{ secrets.TEST_SSH_PORT }}"
          if [ -n "$PORT" ]; then SSH_PORT_FLAG="-p $PORT"; else SSH_PORT_FLAG=""; fi
          TARGET_DIR="${{ secrets.TEST_PATH }}"
          SERVICE_NAME="${{ secrets.TEST_SERVICE_NAME }}"
          if [ -z "$TARGET_DIR" ]; then echo "ERROR: TEST_PATH is not set"; exit 1; fi
          if [ -z "$SERVICE_NAME" ]; then echo "ERROR: TEST_SERVICE_NAME is not set"; exit 1; fi
          echo "Deploying to TEST host=${{ secrets.TEST_HOST }} user=${{ secrets.TEST_USER }} target=$TARGET_DIR service=$SERVICE_NAME"
          ssh $SSH_PORT_FLAG "${{ secrets.TEST_USER }}@${{ secrets.TEST_HOST }}" "set -e; SERVICE=\"$SERVICE_NAME\"; TARGET=\"${TARGET_DIR%/}\"; BACKUP_DIR=\"/var/backups/${SERVICE_NAME}-$(date +%s)\"; sudo mkdir -p \"$BACKUP_DIR\"; sudo systemctl stop \"$SERVICE\" || true; if [ -f \"$TARGET/lazyblog\" ]; then sudo mv -f \"$TARGET/lazyblog\" \"$BACKUP_DIR/\"; fi; if [ -d \"$TARGET/static\" ]; then sudo mv -f \"$TARGET/static\" \"$BACKUP_DIR/\"; fi; if [ -d \"$TARGET/templates\" ]; then sudo mv -f \"$TARGET/templates\" \"$BACKUP_DIR/\"; fi; TMPDIR=\"/tmp/deploy.$$\"; rm -rf \"$TMPDIR\"; mkdir -p \"$TMPDIR\"; sudo tar -xzf ~/deploy.tar.gz -C \"$TMPDIR\"; sudo mkdir -p \"$TARGET\"; if [ -f \"$TMPDIR/lazyblog\" ]; then sudo mv -f \"$TMPDIR/lazyblog\" \"$TARGET/lazyblog\"; sudo chmod +x \"$TARGET/lazyblog\"; fi; if [ -d \"$TMPDIR/static\" ]; then sudo rm -rf \"$TARGET/static\"; sudo mv -f \"$TMPDIR/static\" \"$TARGET/static\"; fi; if [ -d \"$TMPDIR/templates\" ]; then sudo rm -rf \"$TARGET/templates\"; sudo mv -f \"$TMPDIR/templates\" \"$TARGET/templates\"; fi; rm -rf \"$TMPDIR\"; sudo rm -f ~/deploy.tar.gz; sudo systemctl start \"$SERVICE\"; sleep 3; if curl -sSf --max-time 2 http://127.0.0.1:8080/ready >/dev/null 2>&1; then ls -dt /var/backups/${SERVICE_NAME}-* 2>/dev/null | tail -n +4 | xargs -r sudo rm -rf; echo 'health ok'; else echo 'health check failed, rolling back'; sudo systemctl stop \"$SERVICE\" || true; if [ -d \"$BACKUP_DIR\" ]; then if [ -f \"$BACKUP_DIR/lazyblog\" ]; then sudo mv -f \"$BACKUP_DIR/lazyblog\" \"$TARGET/lazyblog\"; sudo chmod +x \"$TARGET/lazyblog\"; fi; if [ -d \"$BACKUP_DIR/static\" ]; then sudo rm -rf \"$TARGET/static\"; sudo mv -f \"$BACKUP_DIR/static\" \"$TARGET/static\"; fi; if [ -d \"$BACKUP_DIR/templates\" ]; then sudo rm -rf \"$TARGET/templates\"; sudo mv -f \"$BACKUP_DIR/templates\" \"$TARGET/templates\"; fi; sudo systemctl start \"$SERVICE\"; fi; exit 1; fi"

  deploy-prod:
    name: Deploy to production when tag does NOT end with -debug
    runs-on: ubuntu-latest
    needs: build
    if: endsWith(needs.build.outputs.tag, '-debug') == false
    steps:
      - name: Download built binary
        uses: actions/download-artifact@v4
        with:
          name: lazyblog-binary

      - name: Prepare SSH for prod server
        run: |
          mkdir -p ~/.ssh
          printf '%s' "${{ secrets.PROD_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.PROD_HOST }}" >> ~/.ssh/known_hosts

      - name: Create deploy archive (prod)
        run: |
          FILES="lazyblog"
          if [ -d static ]; then FILES="$FILES static"; fi
          if [ -d templates ]; then FILES="$FILES templates"; fi
          tar -czf deploy.tar.gz $FILES || true

      - name: Upload deploy archive to prod host
        run: |
          PORT="${{ secrets.PROD_SSH_PORT }}"
          if [ -n "$PORT" ]; then SCP_PORT_FLAG="-P $PORT"; else SCP_PORT_FLAG=""; fi
          scp $SCP_PORT_FLAG deploy.tar.gz "${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }}:~/deploy.tar.gz"
          rm -f deploy.tar.gz

      - name: Stop service, extract archive, move files and start (prod) with backup & healthcheck
        run: |
          PORT="${{ secrets.PROD_SSH_PORT }}"
          if [ -n "$PORT" ]; then SSH_PORT_FLAG="-p $PORT"; else SSH_PORT_FLAG=""; fi
          TARGET_DIR="${{ secrets.PROD_PATH }}"
          SERVICE_NAME="${{ secrets.PROD_SERVICE_NAME }}"
          if [ -z "$TARGET_DIR" ]; then echo "ERROR: PROD_PATH is not set"; exit 1; fi
          if [ -z "$SERVICE_NAME" ]; then echo "ERROR: PROD_SERVICE_NAME is not set"; exit 1; fi
          echo "Deploying to PROD host=${{ secrets.PROD_HOST }} user=${{ secrets.PROD_USER }} target=$TARGET_DIR service=$SERVICE_NAME"
          ssh $SSH_PORT_FLAG "${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }}" "set -e; SERVICE=\"$SERVICE_NAME\"; TARGET=\"${TARGET_DIR%/}\"; BACKUP_DIR=\"/var/backups/${SERVICE_NAME}-$(date +%s)\"; sudo mkdir -p \"$BACKUP_DIR\"; sudo systemctl stop \"$SERVICE\" || true; if [ -f \"$TARGET/lazyblog\" ]; then sudo mv -f \"$TARGET/lazyblog\" \"$BACKUP_DIR/\"; fi; if [ -d \"$TARGET/static\" ]; then sudo mv -f \"$TARGET/static\" \"$BACKUP_DIR/\"; fi; if [ -d \"$TARGET/templates\" ]; then sudo mv -f \"$TARGET/templates\" \"$BACKUP_DIR/\"; fi; TMPDIR=\"/tmp/deploy.$$\"; rm -rf \"$TMPDIR\"; mkdir -p \"$TMPDIR\"; sudo tar -xzf ~/deploy.tar.gz -C \"$TMPDIR\"; sudo mkdir -p \"$TARGET\"; if [ -f \"$TMPDIR/lazyblog\" ]; then sudo mv -f \"$TMPDIR/lazyblog\" \"$TARGET/lazyblog\"; sudo chmod +x \"$TARGET/lazyblog\"; fi; if [ -d \"$TMPDIR/static\" ]; then sudo rm -rf \"$TARGET/static\"; sudo mv -f \"$TMPDIR/static\" \"$TARGET/static\"; fi; if [ -d \"$TMPDIR/templates\" ]; then sudo rm -rf \"$TARGET/templates\"; sudo mv -f \"$TMPDIR/templates\" \"$TARGET/templates\"; fi; rm -rf \"$TMPDIR\"; sudo rm -f ~/deploy.tar.gz; sudo systemctl start \"$SERVICE\"; sleep 3; if curl -sSf --max-time 2 http://127.0.0.1:8080/ready >/dev/null 2>&1; then ls -dt /var/backups/${SERVICE_NAME}-* 2>/dev/null | tail -n +4 | xargs -r sudo rm -rf; echo 'health ok'; else echo 'health check failed, rolling back'; sudo systemctl stop \"$SERVICE\" || true; if [ -d \"$BACKUP_DIR\" ]; then if [ -f \"$BACKUP_DIR/lazyblog\" ]; then sudo mv -f \"$BACKUP_DIR/lazyblog\" \"$TARGET/lazyblog\"; sudo chmod +x \"$TARGET/lazyblog\"; fi; if [ -d \"$BACKUP_DIR/static\" ]; then sudo rm -rf \"$TARGET/static\"; sudo mv -f \"$BACKUP_DIR/static\" \"$TARGET/static\"; fi; if [ -d \"$BACKUP_DIR/templates\" ]; then sudo rm -rf \"$TARGET/templates\"; sudo mv -f \"$BACKUP_DIR/templates\" \"$TARGET/templates\"; fi; sudo systemctl start \"$SERVICE\"; fi; exit 1; fi"
