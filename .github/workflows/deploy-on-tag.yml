name: Deploy on Tag

on:
  push:
    tags:
      - '*'

jobs:
  build:
    name: Build binary
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.set_tag.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'

      - name: "Build (portable: CGO disabled)"
        env:
          CGO_ENABLED: '0'
          GOOS: 'linux'
          GOARCH: 'amd64'
        run: |
          echo "Building (CGO disabled, GOOS=linux GOARCH=amd64)..."
          go version
          go env
          # Build the main web server binary from cmd/main.go to avoid other CLI mains in cmd/
          # -ldflags "-s -w" strips debug info to make the binary smaller
          go build -v -ldflags "-s -w" -o lazyblog ./cmd/main.go

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: lazyblog-binary
          path: lazyblog

      - id: set_tag
        name: Export tag name
        run: |
          # github.ref is refs/tags/<tag>
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT

  deploy-debug:
    name: Deploy to test (debug) when tag ends with -debug
    runs-on: ubuntu-latest
    needs: build
    if: endsWith(needs.build.outputs.tag, '-debug')
    steps:
      - name: Download built binary
        uses: actions/download-artifact@v4
        with:
          name: lazyblog-binary

      - name: Prepare SSH for test server
        run: |
          mkdir -p ~/.ssh
          printf '%s' "${{ secrets.TEST_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.TEST_HOST }}" >> ~/.ssh/known_hosts

      - name: Upload binary to test host (tmp)
        run: |
          PORT="${{ secrets.TEST_SSH_PORT }}"
          if [ -n "$PORT" ]; then SCP_PORT_FLAG="-P $PORT"; else SCP_PORT_FLAG=""; fi
          # copy to remote user's home as a temporary file, then atomically move with sudo
          scp $SCP_PORT_FLAG lazyblog "${{ secrets.TEST_USER }}@${{ secrets.TEST_HOST }}:~/lazyblog.tmp"

      - name: Stop service, move binary and start (test)
        run: |
          PORT="${{ secrets.TEST_SSH_PORT }}"
          if [ -n "$PORT" ]; then SSH_PORT_FLAG="-p $PORT"; else SSH_PORT_FLAG=""; fi
          TARGET_DIR="${{ secrets.TEST_PATH }}"
          # Remote sequence: stop service, move temp binary into place, set executable, start service
          ssh $SSH_PORT_FLAG "${{ secrets.TEST_USER }}@${{ secrets.TEST_HOST }}" "set -e; sudo systemctl stop ${{ secrets.TEST_SERVICE_NAME }} || true; sudo mv -f ~/lazyblog.tmp \"${TARGET_DIR%/}/lazyblog\"; sudo chmod +x \"${TARGET_DIR%/}/lazyblog\"; sudo systemctl start ${{ secrets.TEST_SERVICE_NAME }}"

  deploy-prod:
    name: Deploy to production when tag does NOT end with -debug
    runs-on: ubuntu-latest
    needs: build
    if: endsWith(needs.build.outputs.tag, '-debug') == false
    steps:
      - name: Download built binary
        uses: actions/download-artifact@v4
        with:
          name: lazyblog-binary

      - name: Prepare SSH for prod server
        run: |
          mkdir -p ~/.ssh
          printf '%s' "${{ secrets.PROD_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.PROD_HOST }}" >> ~/.ssh/known_hosts

      - name: Upload binary to prod host (tmp)
        run: |
          PORT="${{ secrets.PROD_SSH_PORT }}"
          if [ -n "$PORT" ]; then SCP_PORT_FLAG="-P $PORT"; else SCP_PORT_FLAG=""; fi
          scp $SCP_PORT_FLAG lazyblog "${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }}:~/lazyblog.tmp"

      - name: Stop service, move binary and start (prod)
        run: |
          PORT="${{ secrets.PROD_SSH_PORT }}"
          if [ -n "$PORT" ]; then SSH_PORT_FLAG="-p $PORT"; else SSH_PORT_FLAG=""; fi
          TARGET_DIR="${{ secrets.PROD_PATH }}"
          ssh $SSH_PORT_FLAG "${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }}" "set -e; sudo systemctl stop ${{ secrets.PROD_SERVICE_NAME }} || true; sudo mv -f ~/lazyblog.tmp \"${TARGET_DIR%/}/lazyblog\"; sudo chmod +x \"${TARGET_DIR%/}/lazyblog\"; sudo systemctl start ${{ secrets.PROD_SERVICE_NAME }}"
