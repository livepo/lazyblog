 {{ template "header.tmpl" }}
 <title>{{ .Post.Title }}</title>
 <script>
 function relativeTimeSimple(t) {
    const now = new Date();
    const duration = now - t; // æ¯«ç§’æ•°

    if (duration < 0) {
        return "æœªæ¥";
    }

    const seconds = Math.floor(duration / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    const weeks = Math.floor(days / 7);
    const months = Math.floor(days / 30);
    const years = Math.floor(days / 365);

    if (seconds < 60) {
        return `${seconds}ç§’å‰`;
    } else if (minutes < 60) {
        return `${minutes}åˆ†é’Ÿå‰`;
    } else if (hours < 24) {
        return `${hours}å°æ—¶å‰`;
    } else if (days < 7) {
        return `${days}å¤©å‰`;
    } else if (weeks < 4) {
        return `${weeks}å‘¨å‰`;
    } else if (months < 12) {
        return `${months}æœˆå‰`;
    } else {
        return `${years}å¹´å‰`;
    }
}

function submitCommentForm(event) {
  event.preventDefault();
  const form = event.target;
  const formData = new FormData(form);

  // ç®€å•æ ¡éªŒ
  if (!form.nickname.value.trim() || !form.email.value.trim() || !form.comment.value.trim()) {
    alert('è¯·å¡«å†™æ˜µç§°ã€é‚®ç®±å’Œè¯„è®ºå†…å®¹');
    return;
  }

  fetch(form.action, {
    method: 'POST',
    body: formData,
  })
  .then(res => res.ok ? res.text() : Promise.reject('æäº¤å¤±è´¥'))
  .then(data => {
    alert('è¯„è®ºæäº¤æˆåŠŸï¼');
    form.reset();
    fetchComments(); // æäº¤æˆåŠŸååˆ·æ–°è¯„è®ºåˆ—è¡¨
  })
  .catch(err => alert(err));

// æ‹‰å–è¯„è®ºåˆ—è¡¨å¹¶æ¸²æŸ“
function fetchComments() {
  const sid = '{{ .Post.SID }}';
  fetch(`{{ getFromConfig "site.prifix" }}/posts/${sid}/comments`)
    .then(res => res.json())
    .then(list => {
      const commentList = document.querySelector('.comment-list');
      let html = '<h4>è¯„è®ºåˆ—è¡¨:</h4>';
      
      list.forEach(item => {
        // æ ¹æ®websiteæ˜¯å¦æœ‰å†…å®¹æ¥å†³å®šæ˜¯å¦ä½¿ç”¨aæ ‡ç­¾
        const nicknameHtml = item.website 
          ? `<a class="nickname" href="${item.website}">${item.nickname}</a>`
          : item.nickname;
        
        // è½¬æ¢å‘å¸ƒæ—¶é—´ä¸ºç›¸å¯¹æ—¶é—´
        const pubDate = new Date(item.pub_date);
        const relativeTime = relativeTimeSimple(pubDate);
        
        html += `<div class="comment-item">
          <p><strong>${nicknameHtml}:</strong> ${item.content} <span class="meta-verbose">${relativeTime}</span></p>
        </div>`;
      });
      
      commentList.innerHTML = html;
    })
    .catch(() => {});
}

// é¡µé¢åŠ è½½æ—¶æ‹‰å–ä¸€æ¬¡è¯„è®º
// window.addEventListener('DOMContentLoaded', fetchComments);
}
</script>
 {{ template "middle.tmpl" }}
  <div class="right-card">
    <article>
      <h2>{{ .Post.Title }}</h2>
      <ul class="post-meta">
        <li>ğŸ“… å‘è¡¨äº{{ .Post.PubDate.Format "2006-01-02" }}</li>
        <li>ğŸ“ <a href="{{ getFromConfig "site.prifix" }}/posts?category={{ .Post.Category }}">{{ .Post.Category }}</a></li>
        <li>ğŸ·ï¸
          {{ $tags := split .Post.Tags "," }}
          {{ range $idx, $tag := $tags }}
            <a href="{{ getFromConfig "site.prifix" }}/posts?tag={{ $tag }}">{{ $tag }}</a>{{ if lt $idx (sub (len $tags) 1) }} â— {{ end }}
          {{ end }}
        </li>
      </ul>
      <hr />
      <div>{{ .Content }}</div>
    </article>
  </div>

  <div class="right-card comment">
    <form class="form" action="{{ getFromConfig "site.prifix" }}/posts/{{ .Post.SID }}/comment" method="post" onsubmit="submitCommentForm(event)">
      <div class="form-group">
        <label for="nickname">æ˜µç§°:</label>
        <input type="text" id="nickname" name="nickname" required placeholder="è¯·è¾“å…¥æ˜µç§°"/>
      </div>
      <div class="form-group">
        <label for="email">é‚®ç®±:</label>
        <input type="email" id="email" name="email" required placeholder="è¯·è¾“å…¥é‚®ç®±"/>
      </div>
      <div class="form-group">
        <label for="website">ç½‘å€:</label>
        <input type="url" id="website" name="website" placeholder="å¯é€‰ï¼Œè¾“å…¥æ‚¨çš„ç½‘å€"/>
      </div>
      <div class="comment-area">
        <textarea class="comment-input" name="comment" required placeholder="è¯·è¾“å…¥è¯„è®º..."></textarea>
        <button type="submit" class="comment-btn">å‘è¡¨è¯„è®º</button>
      </div>
    </form>
  </div>

  <div class="right-card comment">
    <div class="comment-list" id="comment-list">
      <h4>è¯„è®ºåˆ—è¡¨:</h4>
      <div class="comment-item">
        {{ range .Comments }}
            <div class="comment-item" id="c-{{ .SID }}">
                <p>
                  <strong>
                    {{ if .Website }}
                      <a class="nickname" href="{{ .Website }}">{{ .Nickname }}</a>:
                  {{ else }}
                    {{ .Nickname }}:
                  {{ end }}
                  </strong> {{ .Content }} <span class="meta-verbose">{{ relativeTimeSimple .PubDate }}</span>
                </p>
            </div>
        {{ else }}
            <p>æš‚æ— è¯„è®º ğŸ˜­</p>
        {{ end }}
      </div>
    </div>
  </div>
   {{ template "footer.tmpl" }}